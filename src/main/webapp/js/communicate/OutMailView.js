Ext.ns("OutMailView");var OutMailView=function(){};OutMailView.prototype.getView=function(){return new Ext.Panel({id:"OutMailView",title:"[收件箱]",autoScroll:true,border:false,layout:"border",items:[new Ext.FormPanel({id:"OutMailSearchForm",height:40,region:"north",frame:false,layout:"column",layoutConfig:{align:"middle"},bodyStyle:"padding:10px 10px 10px 10px",defaults:{xtype:"label"},items:[{text:"查询条件:"},{text:"邮件标题"},{width:80,xtype:"textfield",name:"Q_title_S_LK"},{text:"发件人"},{width:80,xtype:"textfield",name:"Q_senderName_S_LK"},{text:"收件人"},{width:80,xtype:"textfield",name:"Q_receiverNames_S_LK"},{xtype:"hidden",id:"Q_outMailFolder.folderId_L_EQ",name:"Q_outMailFolder.folderId_L_EQ"},{xtype:"button",text:"查询",iconCls:"search",handler:function(){var a=Ext.getCmp("OutMailSearchForm");var b=Ext.getCmp("OutMailGrid");if(a.getForm().isValid()){a.getForm().submit({waitMsg:"正在提交查询",url:__ctxPath+"/communicate/listOutMail_.do",params:{folderId:Ext.getCmp("OutMailSearchForm").getForm().findField("Q_outMailFolder.folderId_L_EQ").getValue()},success:function(d,e){var c=Ext.util.JSON.decode(e.response.responseText);b.getStore().loadData(c);}});}}}]}),this.setup()]});};OutMailView.prototype.setFolderId=function(a){this.folderId=a;OutMailView.folderId=a;};OutMailView.prototype.getFolderId=function(){return this.folderId;};OutMailView.prototype.setup=function(){return this.grid();};OutMailView.prototype.grid=function(){var e=new Ext.ux.grid.RowExpander({tpl:new Ext.Template('<div style="padding:5px 5px 5px 62px;"><b>内容摘要:</b> {content}</div>')});var d=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[d,new Ext.grid.RowNumberer(),e,{header:"mailId",dataIndex:"mailId",hidden:true},{header:"阅读",dataIndex:"readFlag",width:40,renderer:function(i,h,f,k,g){var j="";if(i!=0){if(f.data.readFlag==0){j+='<img title="未读" src="'+__ctxPath+'/images/flag/mail/mail.png"/>';}else{j+='<img title="已读" src="'+__ctxPath+'/images/flag/mail/mail_open.png"/>';}}else{j+='<img title="草稿" src="'+__ctxPath+'/images/flag/mail/mail_draft.png"/>';}return j;}},{header:"附件",dataIndex:"fileIds",width:40,renderer:function(i,h,f,k,g){var j="";if(i!=""&&i!="null"){j+='<img title="附件" src="'+__ctxPath+'/images/flag/attachment.png"/>';}return j;}},{header:"回复",dataIndex:"replyFlag",width:40,renderer:function(i,h,f,k,g){var j="";if(i==1){j+='<img title="已回复" src="'+__ctxPath+'/images/flag/mail/replyed.png" style="background: white;"/>';}return j;}},{header:"邮件主题",dataIndex:"title",width:150},{header:"发件人",dataIndex:"senderName",width:80},{header:"收件人",dataIndex:"receiverNames",width:80,renderer:function(f){if(f!=""){return f;}else{return"(收信人未写)";}}},{header:"发信时间",width:80,dataIndex:"mailDate",renderer:function(f){return f.substring(0,10);}},{header:"管理",dataIndex:"mailId",width:60,renderer:function(m,l,i,k,n){var f=OutMailView.folderId;var h=m;var g=i.data.mailId;var j='<button title="删除" value=" " class="btn-del" onclick="OutMailView.remove('+g+","+f+')">&nbsp</button>';j+='&nbsp;<button title="查看" value=" " class="btn-mail_edit" onclick="OutMailView.edit('+h+","+f+","+k+')">&nbsp</button>';return j;}}],defaults:{sortable:true,menuDisabled:false}});var b=this.store();b.load({params:{isFetch:null,start:0,limit:25}});var c=new Ext.grid.GridPanel({id:"OutMailGrid",region:"center",autoHeight:true,tbar:this.topbar(),store:b,plugins:e,trackMouseOver:true,disableSelection:false,loadMask:true,stripeRows:true,cm:a,sm:d,viewConfig:{forceFit:true,autoFill:true,forceFit:true},bbar:new Ext.PagingToolbar({pageSize:25,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录",store:b})});c.addListener("rowdblclick",function(f,h,g){f.getSelectionModel().each(function(j){var i=OutMailView.folderId;OutMailView.edit(j.data.mailId,i,h);});});return c;};OutMailView.prototype.store=function(){var a=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listOutMail_.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"mailId",type:"int"},{name:"readFlag",type:"int"},{name:"replyFlag",type:"int"},"mailDate","fileIds","title","content","senderName","receiverNames","senderAddresses"]}),remoteSort:true});a.setDefaultSort("mailId","desc");return a;};OutMailView.prototype.topbar=function(){var a=new Ext.Toolbar({id:"OutMailFootBar",height:30,bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_remove",text:"删除",xtype:"button",handler:function(){var e=Ext.getCmp("OutMailGrid");var b=e.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var f=Array();for(var d=0;d<b.length;d++){f.push(b[d].data.mailId);}var c=OutMailView.folderId;OutMailView.remove(f,c);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){var d=Ext.getCmp("OutMailGrid");var b=d.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("信息","请选择要移动的邮件！");return;}var e=Array();for(var c=0;c<b.length;c++){e.push(b[c].data.mailId);}OutMailView.moveTo(e);}},{iconCls:"btn-mail_refresh",text:"刷新",handler:function(){Ext.getCmp("OutMailGrid").getStore().reload({params:{isFetch:null,start:0,limit:25}});}}]});return a;};OutMailView.remove=function(c,a){if(a==null||a==undefined){a=1;}var b=Ext.getCmp("OutMailGrid");var d="";if(a==4){d="删除箱的记录一旦删除,将不可恢复!";}Ext.Msg.confirm("信息确认",d+"您确认要删除该记录吗？",function(f){if(f=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelOutMail_.do",params:{ids:c,folderId:a},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");b.getStore().reload({params:{isFetch:null,start:0,limit:25}});}});var e=Ext.getCmp("OutMailCenterView");e.remove("ShowOutMailDetail");var g=Ext.getCmp("OutMailView");g.show();e.doLayout();}});};OutMailView.edit=function(d,a,g){var e=new OutMailView.centerViewToolbar(d,a,g);if(a==3){var b=Ext.getCmp("centerTabPanel");var c=Ext.getCmp("OutMailForm");if(c==null){c=new OutMailForm(d,"draft");b.add(c);b.activate(c);}else{b.remove(c);c=new OutMailForm(d,"draft");b.add(c);b.activate(c);}}else{var h=Ext.getCmp("OutMailCenterView");var i=Ext.getCmp("OutMailView");i.hide();var f=new Ext.Panel({id:"ShowOutMailDetail",title:"[邮件信息]",border:false,tbar:e,autoLoad:{url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:d},method:"Post"}});h.add(f);h.doLayout();}};OutMailView.centerViewToolbar=function(b,a,d){var c=new Ext.Toolbar({height:30,defaultType:"button",bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_back",text:"返回",handler:function(){var e=Ext.getCmp("OutMailCenterView");e.remove("ShowOutMailDetail");var f=Ext.getCmp("OutMailView");f.show();e.doLayout();}},{iconCls:"btn-mail_reply",text:"回复",handler:function(){var f=Ext.getCmp("centerTabPanel");var e=Ext.getCmp("OutMailForm");if(e==null){e=new OutMailForm(b,"reply");f.add(e);f.activate(e);}else{f.remove(e);e=new OutMailForm(b,"reply");f.add(e);f.activate(e);}}},{iconCls:"btn-mail_resend",text:"转发",handler:function(){var f=Ext.getCmp("centerTabPanel");var e=Ext.getCmp("OutMailForm");if(e==null){e=new OutMailForm(b,"forward");f.add(e);f.activate(e);}else{f.remove(e);e=new OutMailForm(b,"forward");f.add(e);f.activate(e);}}},{iconCls:"btn-mail_remove",text:"删除",handler:function(){OutMailView.remove(b,a);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){OutMailView.moveTo(b);}},"->",{iconCls:"btn-up",text:"较旧一封",handler:function(){var f=document.getElementById("__haveNextOutMailFlag");if(f!=null&&f.value!="endPre"){var g=curUserInfo.userId;var e=document.getElementById("__curOutMailId").value;Ext.getCmp("ShowOutMailDetail").load({url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:e,opt:"_pre",folderId:a},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是第一封邮件了");}}},{iconCls:"btn-last",text:"较新一封",handler:function(){var f=document.getElementById("__haveNextOutMailFlag");if(f!=null&&f.value!="endNext"){var g=curUserInfo.userId;var e=document.getElementById("__curOutMailId").value;Ext.getCmp("ShowOutMailDetail").load({url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:e,opt:"_next",folderId:a},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是最后一封邮件了");}}}]});return c;};OutMailView.moveTo=function(c){var b=new OutMailView.moveFormPanel(c);var a=new Ext.Window({x:350,y:100,width:340,height:300,autoHeight:true,title:"移动邮件",iconCls:"btn-mail_move",modal:true,buttonAlign:"center",plain:true,bodyStyle:"padding:5px;",items:[b],buttons:[{text:"确定移动",handler:function(){var d=Ext.getCmp("folderId");if(d==""||d==null||d==undefined){Ext.ux.Toast.msg("操作信息","请先选择文件夹");}else{var e=Ext.getCmp("moveFolderForm");e.getForm().submit({waitMsg:"正在提交用户信息",success:function(h,i){Ext.ux.Toast.msg("操作信息","移动成功！");a.close();var f=Ext.getCmp("OutMailCenterView");f.remove("ShowOutMailDetail");var g=Ext.getCmp("OutMailView");Ext.getCmp("OutMailGrid").getStore().reload({params:{isFetch:null,start:0,limit:25}});g.show();f.doLayout();},failure:function(f,g){Ext.ux.Toast.msg("提示信息",g.result.msg);}});}}},{text:"取消",handler:function(){a.close();}}]});a.show();};OutMailView.moveFormPanel=function(b){var c=new Ext.tree.TreePanel({title:"请选择文件夹",loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listOutMailFolder_.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(d){if(d!=null&&d.id!=0){Ext.getCmp("dispalyFolderName").setValue(d.text);Ext.getCmp("folderId").setValue(d.id);}}}});var a=new Ext.FormPanel({url:__ctxPath+"/communicate/moveOutMail_.do",layout:"table",id:"moveFolderForm",frame:true,defaultType:"textfield",layoutConfig:{columns:1},defaults:{width:296},items:[{xtype:"label",text:"移至:"},{id:"dispalyFolderName",readOnly:true},{xtype:"hidden",id:"folderId",name:"folderId"},{id:"outMailIds",name:"outMailIds",xtype:"hidden",value:b},{xtype:"panel",items:[c]}]});return a;};